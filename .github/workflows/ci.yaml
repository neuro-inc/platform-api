name: Continuous Integration

on:
  push:
  release:
    types: [published]
    tags:
      - artifactory/*

env:
  PIP_EXTRA_INDEX_URL: ${{ format('https://{0}:{1}@{2}/{0}/{3}', secrets.DEVPI_USER, secrets.DEVPI_PASS, secrets.DEVPI_HOST, secrets.DEVPI_INDEX) }}

jobs:

  test:
    name: Run tests
    runs-on: ubuntu-latest
    env:
      CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER_DEV }}
    steps:
      - name: Checkout commit
        uses: actions/checkout@v2
      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: "3.7.7"
      - name: Cache packages
        uses: actions/cache@v1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py-3.7.7-${{ hashFiles('requirements/*.txt') }}-${{ hashFiles('setup.py') }}
      - name: Install dependencies
        run: make setup
      - name: Lint
        run: make lint
      - name: Run unit tests
        run: make test_unit
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: .coverage-unit.xml
          flags: unit
          name: codecov-unit
      - name: Configure AWS credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to AWS ECR
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/amazon-ecr-login@v1
      - name: Configure Azure credentials
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
      - name: Login to Azure ACR
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.AZURE_DEV_ACR_SERVER }}
          username: ${{ secrets.AZURE_DEV_ACR_USERNAME }}
          password: ${{ secrets.AZURE_DEV_ACR_PASSWORD }}
      - name: Install containerd
        run: |
          # without containerd, tests TestTopApi won't work
          # see https://github.com/neuromation/platform-api/pull/928/files#diff-1d37e48f9ceff6d8030570cd36286a61R76
          export DEBIAN_FRONTEND=noninteractive
          export RELEASE=$(lsb_release -cs)
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository -y \
            "deb [arch=amd64] https://download.docker.com/linux/ubuntu $RELEASE stable"
          sudo apt-get -q update
          sudo apt-get -q install -y \
            docker-ce=5:18.09.4~3-0~ubuntu-$RELEASE \
            docker-ce-cli=5:18.09.4~3-0~ubuntu-$RELEASE \
            containerd.io=1.2.5-1
      - name: Install NFS
        run: |
          sudo apt-get -q update
          sudo apt-get -q install -y nfs-common
          sudo modprobe nfs
          sudo modprobe nfsd
      - name: Start minikube
        run: |
          make install_k8s
          make start_k8s
      - name: Pull test images
        run: make docker_pull_test_images
      - name: Run integration tests
        run: make test_integration
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: .coverage-integration.xml
          flags: integration
          name: codecov-integration
      - name: Run e2e tests
        run: make test_k8s_e2e

  deploy_dev:
    name: Deploy on dev
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master'
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AZURE_ACR_NAME: ${{ secrets.AZURE_DEV_ACR_NAME }}
      AZURE_REGION: ${{ secrets.AZURE_DEV_REGION }}
      AZURE_RG_NAME: ${{ secrets.AZURE_DEV_RG_NAME }}
      CLUSTER_NAME: dev
      HELM_ENV: dev
      HELM_VERSION: ${{ secrets.HELM_VERSION }}
      CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER_DEV }}
    steps:
      - name: Checkout commit
        uses: actions/checkout@v2
      - name: Configure AWS credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to AWS ECR
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/amazon-ecr-login@v1
      - name: Configure Azure credentials
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
      - name: Login to Azure ACR
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.AZURE_DEV_ACR_SERVER }}
          username: ${{ secrets.AZURE_DEV_ACR_USERNAME }}
          password: ${{ secrets.AZURE_DEV_ACR_PASSWORD }}
      - name: Push images to registry
        run: make docker_push
      - name: Update kube config
        run: make ${{ env.CLOUD_PROVIDER }}_k8s_login
      - name: Install helm
        run: make helm_install
      - name: Deploy to kubernetes
        run: make helm_deploy

  deploy_staging:
    name: Deploy on staging
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/heads/release/')
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AZURE_ACR_NAME: ${{ secrets.AZURE_STAGING_ACR_NAME }}
      AZURE_REGION: ${{ secrets.AZURE_STAGING_REGION }}
      AZURE_RG_NAME: ${{ secrets.AZURE_STAGING_RG_NAME }}
      CLUSTER_NAME: staging
      HELM_ENV: staging
      HELM_VERSION: ${{ secrets.HELM_VERSION }}
      CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER_STAGING }}
    steps:
      - name: Checkout commit
        uses: actions/checkout@v2
      - name: Configure AWS credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to AWS ECR
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/amazon-ecr-login@v1
      - name: Configure Azure credentials
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
      - name: Login to Azure ACR
        if: env.CLOUD_PROVIDER == 'azure'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.AZURE_STAGING_ACR_SERVER }}
          username: ${{ secrets.AZURE_STAGING_ACR_USERNAME }}
          password: ${{ secrets.AZURE_STAGING_ACR_PASSWORD }}
      - name: Push images to registry
        run: make docker_push
      - name: Update kube config
        run: make ${{ env.CLOUD_PROVIDER }}_k8s_login
      - name: Install helm
        run: make helm_install
      - name: Deploy to kubernetes
        run: make helm_deploy

  deploy_artifactory:
    name: Deploy on artifactory
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'release'
    env:
      ARTIFACTORY_DOCKER_REPO: ${{ secrets.ARTIFACTORY_PRIVATE_DOCKER_REPO }}
      ARTIFACTORY_HELM_REPO: ${{ secrets.ARTIFACTORY_PRIVATE_HELM_REPO }}
      ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
      ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
      HELM_VERSION: ${{ secrets.HELM_VERSION }}
    steps:
      - name: Checkout commit
        uses: actions/checkout@v2
      - name: Artifactory Docker Push
        run: make artifactory_docker_push
      - name: Artifactory Helm Push
        run: make artifactory_helm_push
